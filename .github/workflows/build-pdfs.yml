name: Build Course Snapshot PDFs

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout repository
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Set up Python
      # ------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # 3. Install system dependencies REQUIRED for lxml
      # ------------------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxml2-dev \
            libxslt-dev \
            python3-dev

      # ------------------------------------------------------------
      # 4. Install Python dependencies
      # ------------------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ------------------------------------------------------------
      # 5. Verify lxml is available (sanity check)
      # ------------------------------------------------------------
      - name: Verify lxml installation
        run: |
          python - <<EOF
          import lxml
          print("lxml version:", lxml.__version__)
          EOF

      # ------------------------------------------------------------
      # 6. Run course extraction
      # ------------------------------------------------------------
      - name: Run course extraction
        run: |
          python extractor/extract_courses.py

      # ------------------------------------------------------------
      # 7. Build PDFs
      # ------------------------------------------------------------
      - name: Build PDFs
        run: |
          python pdf/build_pdfs.py

      # ------------------------------------------------------------
      # 8. Upload PDFs as artifacts
      # ------------------------------------------------------------
      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: course-snapshot-pdfs
          path: output/pdfs

      # ------------------------------------------------------------
      # 9. Upload extracted JSON (debugging / audit)
      # ------------------------------------------------------------
      - name: Upload extracted JSON
        uses: actions/upload-artifact@v4
        with:
          name: extracted-data
          path: extracted.json
